body:
    $let:
        appointmentId: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='appointmentId').answer.value.string").0
        service: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='service').answer.value.Coding").0
        patientId: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='patientId').answer.value.string").0
        startDate: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='date').answer.value.date").0
        startTime: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='start-time').answer.value.time").0
        endTime: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='end-time').answer.value.time").0
        patientName: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='patientName').answer.value.string").0
        practitionerRole: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='practitioner-role').answer.value.Reference").0
    $body:
        type: transaction
        entry:
            - request:
                  url: /Encounter
                  method: POST
              resource:
                  class:
                      code: $ service.code
                      system: $ service.system
                      display: $ service.display
                  period:
                      start: $ startDate + 'T' + startTime
                      end: $ startDate + 'T' + endTime
                  status: in-progress
                  subject:
                      id: $ patientId
                      display: $ patientName
                      resourceType: Patient
                  participant:
                      - individual:
                            id: $ practitionerRole.id
                            display: $ practitionerRole.display
                            resourceType: $ practitionerRole.resourceType
                  appointment:
                      $if: $ appointmentId
                      $then:
                          - resourceType: Appointment
                            id: $ appointmentId
                  resourceType: Encounter
        resourceType: Bundle
id: encounter-create-extract
resourceType: Mapping
