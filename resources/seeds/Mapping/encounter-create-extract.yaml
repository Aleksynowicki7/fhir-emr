body:
  $let:
    appointmentId: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='appointmentId').answer.valueString").0
    service: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='service').answer.valueCoding").0
    patientId: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='patientId').answer.valueString").0
    startDate: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='date').answer.valueDate").0
    startTime: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='start-time').answer.valueTime").0
    endTime: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='end-time').answer.valueTime").0
    patientName: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='patientName').answer.valueString").0
    practitionerRole: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='practitioner-role').answer.valueReference").0
  $body:
    $let:
      selectedPractitionerRoleReferenceSplit:
        $call: splitStr
        $args:
          - $ practitionerRole.reference
          - "/"
    $body:
      type: transaction
      entry:
        - request:
            url: /Encounter
            method: POST
          resource:
            class:
              code: $ service.code
              system: $ service.system
              display: $ service.display
            period:
              start: $ startDate + 'T' + startTime
              end: $ startDate + 'T' + endTime
            status: in-progress
            subject:
              id: $ patientId
              display: $ patientName
              resourceType: Patient
            participant:
              - individual:
                  id: $ selectedPractitionerRoleReferenceSplit.1
                  resourceType: $ selectedPractitionerRoleReferenceSplit.0
                  display: $ practitionerRole.display
            appointment:
              $if: $ appointmentId
              $then:
                - resourceType: Appointment
                  id: $ appointmentId
            resourceType: Encounter
      resourceType: Bundle
id: encounter-create-extract
resourceType: Mapping
