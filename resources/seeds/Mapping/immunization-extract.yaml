body:
    $let:
        qrId: $ fhirpath("QuestionnaireResponse.id")
        qrVersion: $ fhirpath("QuestionnaireResponse.meta.versionId")
        qrLastUpdated: >-
            $ fhirpath("QuestionnaireResponse.meta.lastUpdated") || fhirpath("QuestionnaireResponse.repeat(item).where(linkId='dateTime').answer.value.dateTime").0
        immunizationId: $ fhirpath("Provenance.target.where(resourceType='Immunization').id").0
        practitioner: $ Practitioner
        encounterId: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='encounterId').answer.value.string").0
        patientId: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='patientId').answer.value.string").0
        patientName: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='patientName').answer.value.string").0
        vaccineCode: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='vaccine-code').answer.value.Coding").0
        dateOfInjection: >-
            $
            fhirpath("QuestionnaireResponse.repeat(item).where(linkId='date-of-injection').answer.value.date").0
    $body:
        type: transaction
        entry:
            - request:
                  $if: $ immunizationId
                  $then:
                      url: $ "/Immunization/" + immunizationId
                      method: PUT
                  $else:
                      url: /Immunization
                      method: POST
              fullUrl: urn:uuid:immunization-id
              resource:
                  status: completed
                  patient:
                      id: $ patientId
                      display: $ patientName
                      resourceType: Patient
                  encounter:
                      $if: encounterId
                      id: $ encounterId
                      resourceType: Encounter
                  vaccineCode:
                      coding:
                          - $ vaccineCode
                  occurrence:
                      dateTime: $ dateOfInjection
                  resourceType: Immunization
            - request:
                  url: /Provenance
                  method: POST
              resource:
                  resourceType: Provenance
                  target:
                      - uri: urn:uuid:immunization-id
                  recorded: $ qrLastUpdated
                  activity:
                      $if: $ immunizationId
                      $then:
                          coding:
                              - code: 'UPDATE'
                                display: 'revise'
                                system: 'http://terminology.hl7.org/CodeSystem/v3-DataOperation'
                      $else:
                          coding:
                              - code: 'CREATE'
                                display: 'create'
                                system: 'http://terminology.hl7.org/CodeSystem/v3-DataOperation'
                  agent:
                      - who:
                            id: $ practitioner.id
                            resourceType: $ practitioner.resourceType
                            display: $ practitioner.name.0.given.0 + ' ' + practitioner.name.0.family
                  entity:
                      - role: source
                        what:
                            uri: $ "QuestionnaireResponse/" + qrId + "/_history/" + qrVersion
        resourceType: Bundle
id: immunization-extract
resourceType: Mapping
