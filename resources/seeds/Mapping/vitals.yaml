id: vitals
resourceType: Mapping
body:
    $let:
        patientId: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='patientId').answer.value.string").0
        patientName: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='patientName').answer.value.string").0
        encounterId: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='encounterId').answer.value.integer").0
        temperature: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='temperature').answer.value.integer").0
        bloodPressureSystolic: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='blood-pressure-systolic').answer.value.integer").0
        bloodPressureDiastolic: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='blood-pressure-diastolic').answer.value.integer").0
        bloodPressureArm: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='blood-pressure-arm').answer.value.Coding").0
        bloodPressurePosition: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='blood-pressure-positions').answer.value.Coding").0
        pulseRate: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='pulse-rate').answer.value.integer").0
        respiratoryRate: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='respiratory-rate').answer.value.integer").0
        oxygenSaturation: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='oxygen-saturation').answer.value.integer").0
        height: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='height').answer.value.integer").0
        weight: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='weight').answer.value.integer").0
        bmi: >-
            $ fhirpath("QuestionnaireResponse.repeat(item).where(linkId='bmi').answer.value.integer").0
    $body:
        type: transaction
        entry:
            - request:
                  url: /Observation
                  method: POST
              resource:
                  resourceType: Observation
                  status: final
                  code:
                      coding:
                          - code: 8310-5
                            system: http://loinc.org
                            display: Body temperature
                  subject:
                      id: $ patientId
                      display: $ patientName
                      resourceType: Patient
                  encounter:
                      id: $ encounterId
                      resourceType: Encounter
                  value:
                      Quantity:
                          value: $ temperature
                          unit: degC

            - request:
                  url: /Observation
                  method: POST
              resource:
                  resourceType: Observation
                  status: final
                  code:
                      coding:
                          - code: 85354-9
                            system: http://loinc.org
                            display: Blood pressure
                  subject:
                      id: $ patientId
                      display: $ patientName
                      resourceType: Patient
                  encounter:
                      id: $ encounterId
                      resourceType: Encounter
                  bodySite:
                      coding:
                          - $ bloodPressureArm
                          - $ bloodPressurePosition
                  component:
                      - code:
                            coding:
                                - code: 8480-6
                                  system: http://loinc.org
                                  display: Systolic blood pressure
                        value:
                            Quantity:
                                value: $ bloodPressureSystolic
                                unit: mmHg
                      - code:
                            coding:
                                - code: 8462-4
                                  system: http://loinc.org
                                  display: Diastolic blood pressure
                        value:
                            Quantity:
                                value: $ bloodPressureDiastolic
                                unit: mmHg

            - request:
                  url: /Observation
                  method: POST
              resource:
                  resourceType: Observation
                  status: final
                  code:
                      coding:
                          - code: 8867-4
                            system: http://loinc.org
                            display: Heart rate
                  subject:
                      id: $ patientId
                      display: $ patientName
                      resourceType: Patient
                  encounter:
                      id: $ encounterId
                      resourceType: Encounter
                  value:
                      Quantity:
                          value: $ pulseRate
                          unit: /min

            - request:
                  url: /Observation
                  method: POST
              resource:
                  resourceType: Observation
                  status: final
                  code:
                      coding:
                          - code: 9279-1
                            system: http://loinc.org
                            display: Respiratory rate
                  subject:
                      id: $ patientId
                      display: $ patientName
                      resourceType: Patient
                  encounter:
                      id: $ encounterId
                      resourceType: Encounter
                  value:
                      Quantity:
                          value: $ respiratoryRate
                          unit: /min

            - request:
                  url: /Observation
                  method: POST
              resource:
                  resourceType: Observation
                  status: final
                  code:
                      coding:
                          - code: 59408-5
                            system: http://loinc.org
                            display: Oxygen saturation
                  subject:
                      id: $ patientId
                      display: $ patientName
                      resourceType: Patient
                  encounter:
                      id: $ encounterId
                      resourceType: Encounter
                  value:
                      Quantity:
                          value: $ oxygenSaturation
                          unit: "%"

            - request:
                  url: /Observation
                  method: POST
              resource:
                  resourceType: Observation
                  status: final
                  code:
                      coding:
                          - code: 8302-2
                            system: http://loinc.org
                            display: Body height
                  subject:
                      id: $ patientId
                      display: $ patientName
                      resourceType: Patient
                  encounter:
                      id: $ encounterId
                      resourceType: Encounter
                  value:
                      Quantity:
                          value: $ height
                          unit: cm

            - request:
                  url: /Observation
                  method: POST
              resource:
                  resourceType: Observation
                  status: final
                  code:
                      coding:
                          - code: 29463-7
                            system: http://loinc.org
                            display: Body weight
                  subject:
                      id: $ patientId
                      display: $ patientName
                      resourceType: Patient
                  encounter:
                      id: $ encounterId
                      resourceType: Encounter
                  value:
                      Quantity:
                          value: $ weight
                          unit: kg

            - request:
                  url: /Observation
                  method: POST
              resource:
                  resourceType: Observation
                  status: final
                  subject:
                      id: $ patientId
                      display: $ patientName
                      resourceType: Patient
                  encounter:
                      id: $ encounterId
                      resourceType: Encounter
                  code:
                      coding:
                          - code: 39156-5
                            system: http://loinc.org
                            display: BMI
                  value:
                      Quantity:
                          value: $ bmi
                          unit: kg/m2
