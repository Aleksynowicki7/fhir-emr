resourceType: Questionnaire
id: new-appointment
status: active
mapping:
  - id: new-appointment-extract
    resourceType: Mapping
launchContext:
  - name:
      code: patient
    type: 
      - Patient
    description: Patient resource
  - name:
      code: practitionerRole
    type:
      - PractitionerRole
    description: PractitionerRole resource
  - name:
      code: appointment
    type:
      - Appointment
    description: Appointment date passing from calendar
contained:
  - resourceType: Bundle
    id: ResourcesBundle
    type: transaction
    entry:
      - request:
          method: GET
          url: /PractitionerRole?_id={{%practitionerRole.id}}&_include=practitioner
      - request:
          method: GET
          url: /HealthcareService?service-type=consultation,follow-up
sourceQueries:
  - localRef: "Bundle#ResourcesBundle"
item:
  - type: group
    linkId: root-group
    item:
      - text: Predefined Practitioner role
        type: string
        linkId: predefined-practitioner-role-id
        hidden: true
        initialExpression:
          language: text/fhirpath
          expression: >-
            %ResourcesBundle.entry.resource
            .entry.resource.where(resourceType='PractitionerRole').id
      - text: Predefined practitioner role display
        type: string
        linkId: predefined-practitioner-role-display
        hidden: true
        itemPopulationContext:
          language: text/fhirpath
          expression: >-
            %ResourcesBundle.entry.resource
            .entry.resource.where(resourceType='Practitioner')
        initialExpression:
          language: text/fhirpath
          expression: >-
            name.given.first() + ' ' + name.family + ' - '
            + %ResourcesBundle.entry.resource
            .entry.resource.where(resourceType='PractitionerRole').specialty.first().coding.display
      - text: Practitioner
        type: reference
        referenceResource:
          - PractitionerRole
        required: true
        linkId: practitioner-role
        enableWhen:
          - question: predefined-practitioner-role-id
            operator: "exists"
            answer:
              boolean: false
        answerExpression:
          language: application/x-fhir-query
          expression: "PractitionerRole?_assoc=practitioner"
        choiceColumn:
          - forDisplay: true
            path: >-
              practitioner.resource.name.given.first() + ' ' + 
              practitioner.resource.name.family + ' - ' + specialty.first().coding.display
      - text: Predefined Patient Id
        type: string
        linkId: predefined-patient-id
        hidden: true
        initialExpression:
          language: text/fhirpath
          expression: "%patient.where($this != 'undefined').id"
      - text: Patient
        type: reference
        required: true
        linkId: patient
        referenceResource:
          - Patient
        enableWhen:
          - question: predefined-patient-id
            operator: "exists"
            answer:
              boolean: false
        answerExpression:
          language: application/x-fhir-query
          expression: "Patient"
        choiceColumn:
          - forDisplay: true
            path: "name.given.first() + ' ' + name.family"
      - text: Service
        type: choice
        required: true
        linkId: service-type
        answerValueSet: "appointment-type"
        enableBehavior: any
        enableWhen:
          - question: predefined-practitioner-role-id
            operator: "exists"
            answer:
              boolean: true
          - question: practitioner-role
            operator: "exists"
            answer:
              boolean: true
        answerOption:
          - value:
              Coding:
                system: http://fhir.org/guides/argonaut-scheduling/CodeSystem/visit-type
                code: consultation
                display: The first appointment
          - value:
              Coding:
                system: http://fhir.org/guides/argonaut-scheduling/CodeSystem/visit-type
                code: follow-up
                display: A follow up visit
      - text: Start time
        required: true
        type: dateTime
        linkId: start-datetime
        initialExpression:
          language: text/fhirpath
          expression: "%appointment.start"
      - text: End time
        required: true
        type: dateTime
        readOnly: true
        linkId: end-datetime
        calculatedExpression:
          language: text/fhirpath
          expression: >-
            %QuestionnaireResponse.repeat(item).where(linkId='start-datetime').answer. valueDateTime
            +
            %ResourcesBundle.entry.resource.entry.resource
            .where(resourceType='HealthcareService')
            .where(
              type.coding.code=%QuestionnaireResponse.repeat(item)
              .where(linkId='service-type').answer.valueCoding.code
            ).extension
            .where(url='urn:extensions:healthcare-service-duration').valueInteger
meta:
  profile:
    - https://beda.software/beda-emr-questionnaire
url: https://aidbox.emr.beda.software/ui/console#/entities/Questionnaire/new-appointment
