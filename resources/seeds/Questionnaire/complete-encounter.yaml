resourceType: Questionnaire
id: complete-encounter
status: active
title: Complete encounter
mapping:
    - id: complete-encounter-extract
      resourceType: Mapping
launchContext:
    - name:
          code: CurrentEncounter
      type: 
        - Encounter
      description: The encounter to complete
contained:
    - resourceType: Bundle
      id: CurrentEncounterBundle
      type: transaction
      entry:
          - request:
                method: GET
                url: /Encounter?_id={{%CurrentEncounter.id}}
    - resourceType: Bundle
      id: CurrentPatientBundle
      type: transaction
      entry:
          - request:
                method: GET
                url: /Patient?_id={{%CurrentEncounter.subject.id}}
    - resourceType: Bundle
      id: CurrentChargeItemDefinitionBundle
      type: transaction
      entry:
          - request:
                method: GET
                url: /ChargeItemDefinition?healthcare-service={{%CurrentEncounter.class.code}}
sourceQueries:
    - localRef: "Bundle#CurrentEncounterBundle"
    - localRef: "Bundle#CurrentPatientBundle"
item:
    - type: group
      linkId: root-group
      item:
      - text: Current Encounter ID
        type: string
        linkId: current-encounter-id
        hidden: true
        initialExpression:
            language: text/fhirpath
            expression: "%CurrentEncounterBundle.entry[0].resource.entry.resource.id"
      - text: Encounter class
        type: string
        linkId: encounter-class
        readOnly: true
        initialExpression:
            language: text/fhirpath
            expression: "%CurrentEncounterBundle.entry[0].resource.entry.resource.class.display"
      - text: Patient
        type: string
        linkId: patient
        readOnly: true
        initialExpression:
            language: text/fhirpath
            expression: "%CurrentPatientBundle.entry[0].resource.entry.resource.name.given[0] + ' ' + %CurrentPatientBundle.entry[0].resource.entry.resource.name.first().family"
      - text: Start
        type: dateTime
        linkId: start-dateTime
        readOnly: true
        initialExpression:
            language: text/fhirpath
            expression: "%CurrentEncounterBundle.entry[0].resource.entry.resource.period.start"
      - text: End
        type: dateTime
        linkId: end-dateTime
        readOnly: true
        initialExpression:
            language: text/fhirpath
            expression: 'now()'
      # - text: ChargeItemDefinitionReferences
      #   type: reference
      #   referenceResource:
      #     - ChargeItemDefinition
      #   required: true
      #   hidden: false
      #   repeats: true
      #   linkId: charge-item-definition-references
      #   answerExpression:
      #       language: application/x-fhir-query
      #       expression: "ChargeItemDefinition"
      #   choiceColumn:
      #       - forDisplay: true
      #         path: >-
      #               id
      #   initialExpression:
      #       language: application/x-fhir-query
      #       expression: "ChargeItemDefinition?healthcare-service={{%CurrentEncounter.class.code}}"
url: https://aidbox.emr.beda.software/ui/console#/entities/Questionnaire/complete-encounter
meta:
    profile:
        - https://beda.software/beda-emr-questionnaire
