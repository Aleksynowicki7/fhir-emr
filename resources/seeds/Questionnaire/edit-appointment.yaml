resourceType: Questionnaire
id: edit-appointment
status: active
# mapping:
#   - id: new-appointment-extract
#     resourceType: Mapping
launchContext:
  - name: CurrentAppointmentId
    type: string
    description: The edited appointment ID
  - name: OrganizationId
    type: string
    description: The organization ID
contained:
  - resourceType: Bundle
    id: CurrentAppointmentBundle
    type: searchset
    entry:
      - request:
          method: GET
          url: /Appointment?_id={{%CurrentAppointmentId}}
sourceQueries:
  - localRef: "Bundle#CurrentAppointmentBundle"
item:
  - type: group
    linkId: root-group
    item:
      - text: Current Appointment ID
        type: string
        linkId: current-appointment-id
        hidden: true
        initialExpression:
          language: text/fhirpath
          expression: "%CurrentAppointmentId"
      - text: Practitioner
        type: reference
        referenceResource:
          - PractitionerRole
        required: true
        linkId: practitioner-role
        answerExpression:
          language: application/x-fhir-query
          expression: "PractitionerRole?organization={{%OrganizationId}}&location:missing=false&_assoc=practitioner"
        choiceColumn:
          - forDisplay: true
            path: "practitioner.resource.name.given.first() + ' ' + practitioner.resource.name.family"
        initialExpression:
          language: text/fhirpath
          expression: "%CurrentAppointmentBundle.entry[0].resource.entry.resource.participant.actor.where(resourceType='PractitionerRole')"
      - text: Type
        type: reference
        required: true
        linkId: service-type
        referenceResource:
          - HealthcareService
        answerExpression:
          language: application/x-fhir-query
          expression: "HealthcareService?organization={{%OrganizationId}}&_has:PractitionerRole:service:id={{%QuestionnaireResponse.repeat(item).where(linkId='practitioner-role').answer.value.children().id}}"
        choiceColumn:
          - forDisplay: true
            path: "name"
        enableBehavior: any
        enableWhen:
          - question: practitioner-role
            operator: "exists"
            answer:
              boolean: true
      - text: Patient
        type: reference
        required: true
        linkId: patient
        initialExpression:
          language: text/fhirpath
          expression: "%CurrentAppointmentBundle.entry[0].resource.entry.resource.participant.actor.where(resourceType='Patient')"
      - text: Location
        type: reference
        required: true
        linkId: location
        readOnly: true
        enableBehavior: any
        initialExpression:
          language: text/fhirpath
          expression: "%CurrentAppointmentBundle.entry[0].resource.entry.resource.participant.actor.where(resourceType='Location')"
        enableWhen:
          - question: patient
            operator: "exists"
            answer:
              boolean: true
      - text: Appointment date
        required: true
        type: date
        linkId: appointment-date
        initialExpression:
          language: text/fhirpath
          expression: "%CurrentAppointmentBundle.entry[0].resource.entry.resource.start.substring(0,10)"
      - text: Start datetime
        required: true
        type: dateTime
        linkId: start-datetime
        initialExpression:
          language: text/fhirpath
          expression: "%CurrentAppointmentBundle.entry[0].resource.entry.resource.start"
